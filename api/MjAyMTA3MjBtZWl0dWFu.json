{"title":"逆向美团APP探索mtgsig加密算法","date":"2021-07-20T21:07:59.000Z","date_formatted":{"ll":"2021年7月20日","L":"2021/07/20","MM-DD":"07-20"},"link":"20210720meituan","tags":["mtgsig","美团","美团团购","逆向爬虫"],"updated":"2021-07-20T13:18:46.038Z","content":"<p>简单逆向并且分析了美团app 的加密字段。使用hook 的方式进行调用。</p>\n<p>下面是详细的分析过程。</p>\n<h2 id=\"分析过程\">分析过程<a title=\"#分析过程\" href=\"#分析过程\"></a></h2>\n<p>抓包店铺详情</p>\n<p><a href=\"http://scapi.waimai.meituan.com/mtapi/v9/poi/food?wm_appversion=11.10.404&amp;utm_medium=android&amp;wm_seq=231&amp;uuid=000000000000062B1FBC7B7904BC3BAE6B73BC9937E2BA162484885268688693&amp;wm_ctype=mtandroid&amp;platform=4&amp;wm_latitude=30546106&amp;wm_actual_longitude=104062093&amp;wm_visitid=d1287073-34b1-4188-9b04-5f0f4889a645&amp;wm_dversion=28_9&amp;wm_mac=02%3A00%3A00%3A00%3A00%3A00&amp;push_token=dpshb7d0b3b5094e580f5b8cb4da2d86cf9catpu&amp;utm_content=990012007480921&amp;app=0&amp;wm_longitude=104062093&amp;utm_campaign=AgroupBgroupC0E0Ghomepage_category38_21112__a1__c-1024&amp;wm_actual_latitude=30546106&amp;ci=30&amp;f=android&amp;waimai_sign=T22ltAgF0RUqghUGkugZVhGQZ7ap8vyHPUbEy3OKfOU682swnAoEPtjCVGNhTYB1RwA1OM72mWRn%0AkE48m4W%2FBzMgri08scvR3oBVn1XV2mt6K%2BqVR7nfPoFUTsDmglDJOemGKF%2FleKUskYllXsrjxKNG%0AMu%2FvFavU2JK47GkuhvE%3D%0A&amp;wm_did=990012007480921&amp;version=11.10.404&amp;req_time=1626684620740&amp;utm_term=1100100404&amp;wm_dtype=Pixel%203&amp;wm_uuid=000000000000062B1FBC7B7904BC3BAE6B73BC9937E2BA162484885268688693&amp;partner=4&amp;utm_source=wandoujia&amp;version_name=11.10.404&amp;msid=9900120074809211626683624711&amp;userid=-1&amp;__reqTraceID=956e1a93-7ea6-4254-925a-a7caa6edd370\">http://scapi.waimai.meituan.com/mtapi/v9/poi/food?wm_appversion=11.10.404&amp;utm_medium=android&amp;wm_seq=231&amp;uuid=000000000000062B1FBC7B7904BC3BAE6B73BC9937E2BA162484885268688693&amp;wm_ctype=mtandroid&amp;platform=4&amp;wm_latitude=30546106&amp;wm_actual_longitude=104062093&amp;wm_visitid=d1287073-34b1-4188-9b04-5f0f4889a645&amp;wm_dversion=28_9&amp;wm_mac=02%3A00%3A00%3A00%3A00%3A00&amp;push_token=dpshb7d0b3b5094e580f5b8cb4da2d86cf9catpu&amp;utm_content=990012007480921&amp;app=0&amp;wm_longitude=104062093&amp;utm_campaign=AgroupBgroupC0E0Ghomepage_category38_21112__a1__c-1024&amp;wm_actual_latitude=30546106&amp;ci=30&amp;f=android&amp;waimai_sign=T22ltAgF0RUqghUGkugZVhGQZ7ap8vyHPUbEy3OKfOU682swnAoEPtjCVGNhTYB1RwA1OM72mWRn\nkE48m4W%2FBzMgri08scvR3oBVn1XV2mt6K%2BqVR7nfPoFUTsDmglDJOemGKF%2FleKUskYllXsrjxKNG\nMu%2FvFavU2JK47GkuhvE%3D\n&amp;wm_did=990012007480921&amp;version=11.10.404&amp;req_time=1626684620740&amp;utm_term=1100100404&amp;wm_dtype=Pixel 3&amp;wm_uuid=000000000000062B1FBC7B7904BC3BAE6B73BC9937E2BA162484885268688693&amp;partner=4&amp;utm_source=wandoujia&amp;version_name=11.10.404&amp;msid=9900120074809211626683624711&amp;userid=-1&amp;__reqTraceID=956e1a93-7ea6-4254-925a-a7caa6edd370</a></p>\n<span id=\"more\"></span>\n<p>搜索 v9/poi/food</p>\n<p><img src=\"http://blog.feilang235.com/(null)-20210720211038619.(null)\" alt=\"img\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"http://blog.feilang235.com/(null)-20210720211208263.(null)\" alt=\"img\" loading=\"lazy\" class=\"φbp\"></p>\n<p>得到 getShopMenu 方法名。</p>\n<p>搜索 getShopMenu</p>\n<p><img src=\"http://blog.feilang235.com/(null)-20210720211234296.(null)\" alt=\"img\" loading=\"lazy\" class=\"φbp\"></p>\n<p>定位到 RestMenuResponse 返回文件夹中。找到方法 fromJson。</p>\n<p>com.sankuai.waimai.store.repository.model.RestMenuResponse</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> RestMenuResponse <span class=\"title\">fromJson</span><span class=\"params\">(JSONObject jSONObject)</span> <span class=\"keyword\">throws</span> JSONException </span>&#123;</span><br></pre></td></tr></table></figure>\n<p>使用 frida hook 确认就是为 返回数据赋值处理。</p>\n<p>Hook 代码</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> hook_js = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> OkHttpClient = Java.use(<span class=\"string\">&quot;okhttp3.OkHttpClient&quot;</span>);</span><br><span class=\"line\">    OkHttpClient.newCall.implementation = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">request</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"built_in\">this</span>.newCall(request);</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(request.toString());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> rest = Java.use(<span class=\"string\">&quot;com.sankuai.waimai.store.repository.model.RestMenuResponse&quot;</span>)</span><br><span class=\"line\">    rest.fromJson.overload(<span class=\"string\">&quot;org.json.JSONObject&quot;</span>).implementation = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">a1</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"built_in\">this</span>.fromJson(a1);</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">&quot;RestMenuResponse&quot;</span>);</span><br><span class=\"line\">        <span class=\"built_in\">console</span>.log(Java.use(<span class=\"string\">&quot;android.util.Log&quot;</span>).getStackTraceString(Java.use(<span class=\"string\">&quot;java.lang.Exception&quot;</span>).$new()));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Java.perform(hook_js);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// frida -U -f com.dianping.v1 --no-pause -l hook_cip.js</span></span><br><span class=\"line\"><span class=\"comment\">// frida -U -l hook_cip.js com.sankuai.meituan.takeoutnew</span></span><br><span class=\"line\"><span class=\"comment\">// 使用方法1 attach : frida -U com.sankuai.meituan --no-pause -l hook_cip.js</span></span><br><span class=\"line\"><span class=\"comment\">// 使用方法2 spawn : frida -U -f com.sankuai.meituan -l hook_cip.js --no-pause</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// com.sankuai.meituan</span></span><br><span class=\"line\"><span class=\"comment\">// frida -U -l hook_cip.js com.sankuai.meituan</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"waimai_sign-签名算法\">waimai_sign 签名算法<a title=\"#waimai_sign-签名算法\" href=\"#waimai_sign-签名算法\"></a></h2>\n<p><img src=\"http://blog.feilang235.com/(null)-20210720211420911.(null)\" alt=\"img\" loading=\"lazy\" class=\"φbp\"></p>\n<h1 id=\"siua-签名字段\">Siua 签名字段<a title=\"#siua-签名字段\" href=\"#siua-签名字段\"></a></h1>\n<p>com.meituan.android.common.mtguard.wtscore.plugin.collection.siua.SIUA</p>\n<p><img src=\"http://blog.feilang235.com/(null)-20210720211442720.(null)\" alt=\"img\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"http://blog.feilang235.com/(null)-20210720211449139.(null)\" alt=\"img\" loading=\"lazy\" class=\"φbp\"></p>\n<p>实现方法</p>\n<p><img src=\"http://blog.feilang235.com/(null)-20210720211502167.(null)\" alt=\"img\" loading=\"lazy\" class=\"φbp\"></p>\n<h1 id=\"mtgsig-加密参数\">mtgsig 加密参数<a title=\"#mtgsig-加密参数\" href=\"#mtgsig-加密参数\"></a></h1>\n<p>com.meituan.android.common.mtguard.wtscore.plugin.sign.core.CandyPreprocessor</p>\n<p><img src=\"http://blog.feilang235.com/(null)-20210720211520495.(null)\" alt=\"img\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"http://blog.feilang235.com/(null)-20210720211527753.(null)\" alt=\"img\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"http://blog.feilang235.com/(null)-20210720211534576.(null)\" alt=\"img\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"http://blog.feilang235.com/(null)-20210720211541115.(null)\" alt=\"img\" loading=\"lazy\" class=\"φbp\"></p>\n<p>com.meituan.android.common.mtguard.NBridge</p>\n<p><img src=\"http://blog.feilang235.com/(null)-20210720211554151.(null)\" alt=\"img\" loading=\"lazy\" class=\"φbp\"></p>\n<p>到此分析完毕，可以使用 hook的方式进行调用了。</p>\n<h2 id=\"参考链接\">参考链接<a title=\"#参考链接\" href=\"#参考链接\"></a></h2>\n<p>美团app</p>\n<p><a href=\"https://cloud.tencent.com/developer/article/1819803\">https://cloud.tencent.com/developer/article/1819803</a></p>\n<p>美团外卖</p>\n<p><a href=\"https://blog.csdn.net/someby/article/details/113189788\">https://blog.csdn.net/someby/article/details/113189788</a></p>\n","prev":{"title":"快手 sig 加密算法分析爬虫接口","link":"20210728kuaishou"},"next":{"title":"实战逆向贝壳Authorization加密算法","link":"20210714beike"},"plink":"http://feilang235.com/20210720meituan/","toc":[{"id":"分析过程","title":"分析过程","index":"1"},{"id":"waimai_sign-签名算法","title":"waimai_sign 签名算法","index":"2"}],"copyright":{"author":"feilang235","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\\\"https://creativecommons.org/licenses/by-nc-sa/4.0/\\\" rel=\\\"external nofollow\\\" target=\\\"_blank\\\">CC BY-NC-ND 4.0</a>)","published":"2021年7月20日"},"reading_time":"563 字约 4 分钟"}